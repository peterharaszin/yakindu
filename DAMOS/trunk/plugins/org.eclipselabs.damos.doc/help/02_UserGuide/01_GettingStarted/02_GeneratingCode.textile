
h1. Generating C Code

In this section you will learn how to generate C code from a Damos model and how to integrate the generated C code in existing applications. We assume that you read the previous topic and know how to create a basic Damos model.

h2. Example Model

The example model will be a simple PI controller-based speed control with an anti-windup circuit. The inputs of the controller will be the desired speed and the actual speed. The output value (i.e. engine power) will be limited to a value between 0.0 and 1.0 (0% to 100%). The anti-windup circuit is needed to prevent the integrator to windup when the maximum output power is reached.

To create the example model:

* Create a new block diagram in the model folder of a new Damos project (see previous topic for more details):
## Create a new Damos project (*File > New > Project...* and then select *Damos > Damos Project*).
## Create a model folder in the new Damos project.
## Create a new block diagram in the model folder (*File > New > Other...* and then select *New Block Diagram*).
* From the *General* palette drawer, add two *Inport* blocks and one *Outport* block to the block diagram.
* Red markers will indicate that the data types are missing. To fix this, specify *real* as data type for all Inports and Outports using the Properties view. Alternatively, you can use the quick fix from the tool tip of the error marker.
* Name the two Inports _DesiredSpeed_ and _ActualSpeed_, and the Outport _Power_.
* Optionally, for each Inport and Outport select *Show Name* in the *Appearance* property tab to show their names.

The block diagram should look as follows:

!02_GeneratingCode_images/InitialBlockDiagram.png(Initial block diagram)!

You may ask, why do we need these Inports and Outports? As we will see later, those blocks will represent the interface of our system in the generated code.

Next, we add the following block to the block diagram:

* 2 *Sum* blocks
* *Gain* block with a gain value of 0.1
* *Constant* block with a value of 0
* *Switch* block
* *Discrete Integrator* block with an initial value of 0 and a gain value of 0.075(1/s)
* *Saturate* block with upper limit of 1 and lower limit of 0
* *Compare* block with an equals ('==') operator

After connecting the blocks, the block diagram should look as follows: 

!02_GeneratingCode_images/FinalBlockDiagram.png(Final block diagram)!

h2. Creating Generator Configuration

To generate code from a Damos model, we need to create a _generator configuration_. To create the generator configuration:

* Right-click the block diagram in the project explorer, and then *New > Other...*.
* Select *Damos > C Code Generator Configuration*: !02_GeneratingCode_images/NewCCodeGeneratorConfiguration.png(New C code generator configuration wizard)!
* Click *Finish*

After clicking *Finish*, the new generator configuration file with the extension _.dconfig_ should be opened in a text editor. It should have the following contents:

bc.. package speedcontrol

import damos.codegen.*
import damos.codegen.c.*

configuration GenerateSpeedControl {

	select generator DefaultGenerator {
		projectName = "SpeedControl"
		sourceFolder = "src-gen"
		systemSourceFile = "SpeedControl.c"
	}

	system SpeedControl {
		prefix = "SpeedControl_"
		//propagate computation {
		//	map real() to float64
		//	map int() to int32
		//}
	}

}
p. The @projectName@ and @sourceFolder@ properties specify the target project and source folder, respectively. If you want to generate the code into another project or folder, you can change those properties accordingly.

h2. Generating Source Code

To start the code generation process, right-click on the generator configuration file (in our example _GenerateSpeedControl.dconfig_) and select *Generate Code*. The target source folder should now contain a C header file (.h) and a C source file (.c).

h2. Integrating the Generated Code in Existing Applications
