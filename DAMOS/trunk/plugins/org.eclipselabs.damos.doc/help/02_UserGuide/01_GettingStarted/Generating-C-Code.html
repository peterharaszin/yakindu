<?xml version='1.0' encoding='utf-8' ?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>Getting Started - Generating C Code</title><link type="text/css" rel="stylesheet" href="../content/PLUGINS_ROOT/PRODUCT_PLUGIN/book.css"/><link type="text/css" rel="stylesheet" href="../../style.css"/></head><body><table class="navigation" style="width: 100%;" border="0" summary="navigation"><tr><th style="width: 100%" align="center" colspan="3">Generating C Code</th></tr><tr><td style="width: 20%" align="left"><a href="GettingStarted.html" title="Creating and Simulating a Damos Model"><img alt="Previous" border="0" src="images/prev.gif"/></a></td><td style="width: 60%" align="center"></td><td style="width: 20%" align="right"></td></tr><tr><td style="width: 20%" align="left" valign="top">Creating and Simulating a Damos Model</td><td style="width: 60%" align="center"></td><td style="width: 20%" align="right" valign="top"></td></tr></table><hr/><h1 id="GeneratingCCode">Generating C Code</h1><p>In this section you will learn how to generate C code from a Damos model and how to integrate the generated C code in existing applications. We assume that you read the previous topic and know how to create a basic Damos model.</p><h2 id="ExampleModel">Example Model</h2><p>The example model will be a simple PI controller-based speed control with an anti-windup circuit. The inputs of the controller will be the desired speed and the actual speed. The output value (i.e. engine power) will be limited to a value between 0.0 and 1.0 (0% to 100%). The anti-windup circuit is needed to prevent the integrator to windup when the maximum output power is reached.</p><p>To create the example model:</p><ul><li>Create a new block diagram in the model folder of a new Damos project (see previous topic for more details):<ol><li>Create a new Damos project (<strong>File &gt; New &gt; Project...</strong> and then select <strong>Damos &gt; Damos Project</strong>).</li><li>Create a model folder in the new Damos project.</li><li>Create a new block diagram in the model folder (<strong>File &gt; New &gt; Other...</strong> and then select <strong>New Block Diagram</strong>).</li></ol></li><li>From the <strong>General</strong> palette drawer, add two <strong>Inport</strong> blocks and one <strong>Outport</strong> block to the block diagram.</li><li>Red markers will indicate that the data types are missing. To fix this, specify <strong>real</strong> as data type for all Inports and Outports using the Properties view. Alternatively, you can use the quick fix from the tool tip of the error marker.</li><li>Name the two Inports <em>DesiredSpeed</em> and <em>ActualSpeed</em>, and the Outport <em>Power</em>.</li><li>Optionally, for each Inport and Outport select <strong>Show Name</strong> in the <strong>Appearance</strong> property tab to show their names.</li></ul><p>The block diagram should look as follows:</p><p><img alt="Initial block diagram" title="Initial block diagram" border="0" src="02_GeneratingCode_images/InitialBlockDiagram.png"/></p><p>You may ask, why do we need these Inports and Outports? As we will see later, those blocks will represent the interface of our system in the generated code.</p><p>Next, we add the following block to the block diagram:</p><ul><li>2 <strong>Sum</strong> blocks</li><li><strong>Gain</strong> block with a gain value of 0.1</li><li><strong>Constant</strong> block with a value of 0</li><li><strong>Switch</strong> block</li><li><strong>Discrete Integrator</strong> block with an initial value of 0 and a gain value of 0.075(1/s)</li><li><strong>Saturate</strong> block with upper limit of 1 and lower limit of 0</li><li><strong>Compare</strong> block with an equals (&#8216;==&#8217;) operator</li></ul><p>After connecting the blocks, the block diagram should look as follows: </p><p><img alt="Final block diagram" title="Final block diagram" border="0" src="02_GeneratingCode_images/FinalBlockDiagram.png"/></p><h2 id="CreatingGeneratorConfiguration">Creating Generator Configuration</h2><p>To generate code from a Damos model, we need to create a <em>generator configuration</em>. To create the generator configuration:</p><ul><li>Right-click the block diagram in the project explorer, and then <strong>New &gt; Other...</strong>.</li><li>Select <strong>Damos &gt; C Code Generator Configuration</strong>: <img alt="New C code generator configuration wizard" title="New C code generator configuration wizard" border="0" src="02_GeneratingCode_images/NewCCodeGeneratorConfiguration.png"/></li><li>Click <strong>Finish</strong></li></ul><p>After clicking <strong>Finish</strong>, the new generator configuration file with the extension <em>.dconfig</em> should be opened in a text editor. It should have the following contents:</p><pre><code>package speedcontrol

import damos.codegen.*
import damos.codegen.c.*

configuration GenerateSpeedControl {

	select generator DefaultGenerator {
		projectName = "SpeedControl"
		sourceFolder = "src-gen"
		systemSourceFile = "SpeedControl.c"
	}

	system SpeedControl {
		prefix = "SpeedControl_"
		//propagate computation {
		//	map real() to float64
		//	map int() to int32
		//}
	}

}
</code></pre><p>The <code>projectName</code> and <code>sourceFolder</code> properties specify the target project and source folder, respectively. If you want to generate the code into another project or folder, you can change those properties accordingly.</p><h2 id="GeneratingSourceCode">Generating Source Code</h2><p>To start the code generation process, right-click on the generator configuration file (in our example <em>GenerateSpeedControl.dconfig</em>) and select <strong>Generate Code</strong>. The target source folder should now contain a C header file (.h) and a C source file (.c).</p><h2 id="IntegratingtheGeneratedCodeinExistingApplications">Integrating the Generated Code in Existing Applications</h2><hr/><table class="navigation" style="width: 100%;" border="0" summary="navigation"><tr><td style="width: 20%" align="left"><a href="GettingStarted.html" title="Creating and Simulating a Damos Model"><img alt="Previous" border="0" src="images/prev.gif"/></a></td><td style="width: 60%" align="center"><a href="GettingStarted.html" title="Getting Started"><img alt="Getting Started" border="0" src="images/home.gif"/></a></td><td style="width: 20%" align="right"></td></tr><tr><td style="width: 20%" align="left" valign="top">Creating and Simulating a Damos Model</td><td style="width: 60%" align="center"></td><td style="width: 20%" align="right" valign="top"></td></tr></table></body></html>