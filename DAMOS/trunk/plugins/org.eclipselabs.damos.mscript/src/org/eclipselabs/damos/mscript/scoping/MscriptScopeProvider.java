/*
 * generated by Xtext
 */
package org.eclipselabs.damos.mscript.scoping;

import java.util.ArrayList;
import java.util.List;

import org.eclipse.emf.ecore.EObject;
import org.eclipse.emf.ecore.EReference;
import org.eclipse.xtext.scoping.IScope;
import org.eclipse.xtext.scoping.Scopes;
import org.eclipse.xtext.scoping.impl.AbstractDeclarativeScopeProvider;
import org.eclipselabs.damos.mscript.Compound;
import org.eclipselabs.damos.mscript.ForStatement;
import org.eclipselabs.damos.mscript.FunctionDefinition;
import org.eclipselabs.damos.mscript.FunctionObjectDeclaration;
import org.eclipselabs.damos.mscript.IterationCall;
import org.eclipselabs.damos.mscript.IterationVariable;
import org.eclipselabs.damos.mscript.LetExpression;
import org.eclipselabs.damos.mscript.LetExpressionVariableDeclaration;
import org.eclipselabs.damos.mscript.LetExpressionVariableDeclarationPart;
import org.eclipselabs.damos.mscript.ParameterDeclaration;
import org.eclipselabs.damos.mscript.StateVariableDeclaration;
import org.eclipselabs.damos.mscript.Statement;
import org.eclipselabs.damos.mscript.VariableDeclaration;

public class MscriptScopeProvider extends AbstractDeclarativeScopeProvider {

	public IScope scope_CallableElement(EObject context, EReference reference) {
		List<EObject> elements = new ArrayList<EObject>();
		
		EObject element = context; 
		EObject container = context.eContainer();
		while (container != null) {
			if (container instanceof LetExpression) {
				LetExpression letExpression = (LetExpression) container;
				for (LetExpressionVariableDeclaration variableDeclaration : letExpression.getVariableDeclarations()) {
					for (LetExpressionVariableDeclarationPart part : variableDeclaration.getParts()) {
						elements.add(part);
					}
				}
			} else if (container instanceof IterationCall) {
				IterationCall iterationCall = (IterationCall) container;
				elements.add(iterationCall.getAccumulator());
				elements.addAll(iterationCall.getVariables());
			} else if (container instanceof FunctionDefinition) {
				FunctionDefinition functionDefinition = (FunctionDefinition) container;

				for (StateVariableDeclaration stateVariableDeclaration : functionDefinition.getStateVariableDeclarations()) {
					elements.add(stateVariableDeclaration);
				}

				for (FunctionObjectDeclaration functionObjectDeclaration : functionDefinition.getFunctionObjectDeclarations()) {
					elements.add(functionObjectDeclaration);
				}

				for (ParameterDeclaration parameterDeclaration : functionDefinition.getTemplateParameterDeclarations()) {
					elements.add(parameterDeclaration);
				}
				
				for (ParameterDeclaration parameterDeclaration : functionDefinition.getInputParameterDeclarations()) {
					elements.add(parameterDeclaration);
				}
				
				for (ParameterDeclaration parameterDeclaration : functionDefinition.getOutputParameterDeclarations()) {
					elements.add(parameterDeclaration);
				}

				elements.add(functionDefinition);
			} else if (container instanceof ForStatement) {
				ForStatement forStatement = (ForStatement) container;
				IterationVariable declaredIterationVariable = forStatement.getDeclaredIterationVariable();
				if (declaredIterationVariable != null) {
					elements.add(declaredIterationVariable);
				}
			} else if (container instanceof Compound) {
				Compound compound = (Compound) container;
				for (Statement statement : compound.getStatements()) {
					if (statement == element) {
						break;
					}
					if (statement instanceof VariableDeclaration) {
						elements.add(statement);
					}
				}
			}
			element = container;
			container = container.eContainer();
		}
		
		return Scopes.scopeFor(elements, getDelegate().getScope(context, reference));
	}

}
